\documentclass[10pt]{article}

\usepackage{amsmath}
\usepackage{hyperref}
\usepackage{tikz-cd}
\usepackage{amssymb}
\usepackage{amsthm}
\usepackage{bm}
\usepackage{listings}
\usepackage{bbm}
\usepackage{multicol}
\usepackage{mathtools}
\usepackage{mathpartir}
\usepackage{float}
\usepackage[inline]{enumitem}
\usepackage[margin=1.25in]{geometry}
\usepackage[T1]{fontenc}
\usepackage{kpfonts}

\usetikzlibrary{decorations.pathmorphing}

\input{LaTeX/macros.tex}
\input{macros.tex}

\newcommand{\putS}{\textbf{\texttt{put}}\xspace}
\newcommand{\evaluates}{\Downarrow}

\begin{document}

\section{Specification}

\subsection{Syntax}
\begin{tabular}{l r l l}
    $\mathcal{Q}$, $\mathcal{R}$, $\mathcal{S}$ & \bnfdef & $\exactlyone$ \bnfalt $\any$ \bnfalt $\nonempty$ \bnfalt $\emptyq$ \bnfalt $\every$ \\
    $M$ & \bnfdef & \fungible \bnfalt \unique \bnfalt \immutable \bnfalt \consumable \bnfalt \asset & (type declaration modifiers) \\
    $T$ & \bnfdef & $\boolt$ \bnfalt $\type~t~\is~\overline{M}~T$ \bnfalt $\listq~\tau$ \bnfalt $\{ \overline{x : \tau} \}$ \\
    $\tau$, $\sigma$, $\pi$ & \bnfdef & $\mathcal{Q}~T$ \\
    $\mathcal{S}$ & \bnfdef & $x$ \bnfalt $[]$ \bnfalt $[x]$ \bnfalt $\{ \overline{x : \tau \mapsto x} \}$ \bnfalt $\newc(t, \overline{M}, T)$ \\
    $\mathcal{D}$ & \bnfdef & $x$ \bnfalt $\var~x:\tau$ \bnfalt $\consume$ \\
    $\Decl$ & \bnfdef & $\transformer~f(\overline{x : \tau}) \to x : \tau ~\{ \overline{\Stmt} \}$ & \\
    $\Stmt$ & \bnfdef & $\pass$ & \\
            & \bnfalt & $\mathcal{S} \to \mathcal{D}$ \bnfalt $\mathcal{S} \sends{\mathcal{Q}~\suchthat~f(\overline{x}))} \mathcal{D}$ \bnfalt $\mathcal{S} \to f(\overline{X}) \to \mathcal{D}$ & \\
            & \bnfalt & $\tryS~\{ \overline{\Stmt} \}~\catchS~\{ \overline{\Stmt} \}$ & \\

    $\Prog$ & \bnfdef & $\overline{\Decl}; \overline{\Stmt}$
\end{tabular}

\subsection{Statics}

\framebox{$\Gamma \flowproves S~\ok \flowprovesout \Delta$} \textbf{Statement Well-formedness}
\begin{mathpar}
    \inferrule*[right=Ok-Pass]{
    }{ \Gamma \flowproves \pass~\ok \flowprovesout \Gamma }

    \inferrule*[right=Ok-Flow-Every]{
        \Gamma \flowproves A : \mathcal{Q}~T \flowprovesout \Delta
        \\
        \Delta[A \leftarrow \Delta(A) \ominus \mathcal{Q}] \flowproves B : \mathcal{R}~T \flowprovesout \Xi
    }{ \Gamma \flowproves (A \to B)~\ok \flowprovesout \Xi[B \leftarrow \Xi(B) \oplus \mathcal{Q}] }

    \inferrule*[right=Ok-Flow-Filter]{
        \Gamma \flowproves A : \mathcal{Q}~T \flowprovesout \Delta
        \\
        \transformer~f(\overline{x : \sigma}, y : \elemtype(T)) \to z : \,\,!~\boolt ~\doC~ \overline{\Stmt}
        \\
        \forall i. \Gamma(a_i) = \sigma_i
        \\
        \Delta[A \leftarrow \Delta(A) \ominus \mathcal{Q}] \flowproves B : \mathcal{S}~T \flowprovesout \Xi
    }{ \Gamma \flowproves (A \sends{\mathcal{R}~\suchthat~f(\overline{a})} B)~\ok \flowprovesout \Xi[B \leftarrow \Xi(B) \oplus \min(\mathcal{Q}, \mathcal{R})] }

    \inferrule*[right=Ok-Flow-Transformer]{
        \Gamma \flowproves A : \mathcal{Q}~T_1 \flowprovesout \Delta
        \\
        \transformer~f(\overline{x : \sigma}, y : \elemtype(T_1)) \to z : \mathcal{R}~T_2~\doC~ \overline{\Stmt}
        \\
        \forall i. \Gamma(x_i) = \sigma_i
        \\
        \forall v \in \overline{x}. \lnot(\Gamma(v)~\asset)
        \\
        \Delta[A \leftarrow \Delta(A) \ominus \mathcal{Q}] \flowproves B : \mathcal{S}~T_2 \flowprovesout \Xi
    }{ \Gamma \flowproves (A \to f(\overline{x}) \to B)~\ok \flowprovesout \Xi[B \leftarrow \Xi(B) \oplus \mathcal{Q}] }

    \inferrule*[right=Ok-Try]{
        \Gamma \flowproves \overline{S_1}~\ok \flowprovesout \Delta
        \\
        \Gamma \flowproves \overline{S_2}~\ok \flowprovesout \Xi
    }{ \Gamma \flowproves (\tryS~\{ \overline{S_1} \}~\catchS~\{ \overline{S_2} \}~\ok \flowprovesout \Delta \sqcup \Xi }
\end{mathpar}

\subsection{Dynamics}
\begin{tabular}{l r l l}
    $\mathcal{V}$ & \bnfdef & $\overline{V}$
\end{tabular}

\begin{mathpar}
    \inferrule*[right=Pass]{
    }{ \Sigma, \pass \to \Sigma }

    \inferrule*[right=Put-Consume]{
    }{ \Sigma, \putS(\mathcal{V}, \consume) \to \Sigma }

    \inferrule*[right=Flow-Every]{
        \Sigma(A) = \mathcal{V}
        \\
        \Sigma(B) = \mathcal{W}
    }{ \angles{\Sigma, A \to B} \evaluates \Sigma[A \leftarrow [], B \leftarrow \mathcal{W}\mathcal{V}] }

    \inferrule*[right=Flow-Filter]{
        \Sigma(A) = \mathcal{V}
        \\
        \Sigma(B) = \mathcal{W}
        \\
        \mathcal{U} = [ v \in \mathcal{V} ~|~ \parens{\Sigma, f(\overline{x}, v) \to^* \Sigma', \ell} \tand \Sigma'(\ell) = \true ]
    }{ \Sigma, (A \sends{\mathcal{Q}~\suchthat~f(\overline{x})} B) \to \Sigma[A \leftarrow \mathcal{V} \setminus \mathcal{U}, B \leftarrow \mathcal{W} \mathcal{U}] }

    \inferrule*[right=Call]{
        \ell \not\in \dom(\Sigma)
        \\
        \transformer~f(\overline{y : \tau}) \to z : \sigma~\doC~S
        \\
        \Sigma[y \leftarrow \ell, \overline{y \leftarrow \Sigma(x)}], f(\overline{x}) \to^* \Sigma'
    }{ \Sigma, f(\overline{x}) \to \Sigma'[\ell \leftarrow \Sigma'(z)], \ell }
\end{mathpar}

\end{document}

