\documentclass[sigconf]{acmart}

\usepackage{listings}
\usepackage{hyperref}
\usepackage{tikz-cd}
% \usepackage{amssymb}
\usepackage{amsthm}
\usepackage{bm}
\usepackage{listings}
\usepackage{mathtools}
\usepackage{mathpartir}
\usepackage{float}
\usepackage{subcaption}
% \usepackage[inline]{enumitem}

%% \BibTeX command to typeset BibTeX logo in the docs
% \AtBeginDocument{%
%   \providecommand\BibTeX{{%
%     \normalfont B\kern-0.5em{\scshape i\kern-0.25em b}\kern-0.8em\TeX}}}

%% Rights management information.  This information is sent to you
%% when you complete the rights form.  These commands have SAMPLE
%% values in them; it is your responsibility as an author to replace
%% the commands and values with those provided to you when you
%% complete the rights form.
% \setcopyright{acmcopyright}
% \copyrightyear{2018}
% \acmYear{2018}
% \acmDOI{10.1145/1122445.1122456}

%% These commands are for a PROCEEDINGS abstract or paper.
% \acmConference[Woodstock '18]{Woodstock '18: ACM Symposium on Neural
%   Gaze Detection}{June 03--05, 2018}{Woodstock, NY}
% \acmBooktitle{Woodstock '18: ACM Symposium on Neural Gaze Detection,
%   June 03--05, 2018, Woodstock, NY}
% \acmPrice{15.00}
% \acmISBN{978-1-4503-XXXX-X/18/06}

%% Submission ID.
%% Use this when submitting an article to a sponsored event. You'll
%% receive a unique submission ID from the organizers
%% of the event, and this ID should be used as the parameter to this command.
%%\acmSubmissionID{123-A56-BU3}

\input{LaTeX/macros.tex}
\input{macros.tex}

\begin{document}

%%
%% The "title" command has an optional parameter,
%% allowing the author to define a "short title" to be used in page headers.
\title{\langName: A DSL for the Safe Management of \AssetTxt{}s in Smart Contracts}

%%
%% The "author" command and its associated commands are used to define
%% the authors and their affiliations.
%% Of note is the shared affiliation of the first two authors, and the
%% "authornote" and "authornotemark" commands
%% used to denote shared contribution to the research.
\author{Reed Oei}
\email{reedoei2@illinois.edu}
\affiliation{%
  \institution{University of Illinois at Urbana-Champaign}
  \city{Urbana}
  \country{USA}
}

%% By default, the full list of authors will be used in the page
%% headers. Often, this list is too long, and will overlap
%% other information printed in the page headers. This command allows
%% the author to define a more concise list
%% of authors' names for this purpose.
% \renewcommand{\shortauthors}{Trovato and Tobin, et al.}

%%
%% The abstract is a short summary of the work to be presented in the
%% article.
% \begin{abstract}
%     Abstract.
% \end{abstract}

%% The code below is generated by the tool at http://dl.acm.org/ccs.cfm.
%% Please copy and paste the code instead of the example below.
% \begin{CCSXML}
% <ccs2012>
%  <concept>
%   <concept_id>10010520.10010553.10010562</concept_id>
%   <concept_desc>Computer systems organization~Embedded systems</concept_desc>
%   <concept_significance>500</concept_significance>
%  </concept>
%  <concept>
%   <concept_id>10010520.10010575.10010755</concept_id>
%   <concept_desc>Computer systems organization~Redundancy</concept_desc>
%   <concept_significance>300</concept_significance>
%  </concept>
%  <concept>
%   <concept_id>10010520.10010553.10010554</concept_id>
%   <concept_desc>Computer systems organization~Robotics</concept_desc>
%   <concept_significance>100</concept_significance>
%  </concept>
%  <concept>
%   <concept_id>10003033.10003083.10003095</concept_id>
%   <concept_desc>Networks~Network reliability</concept_desc>
%   <concept_significance>100</concept_significance>
%  </concept>
% </ccs2012>
% \end{CCSXML}

% \ccsdesc[500]{Computer systems organization~Embedded systems}
% \ccsdesc[300]{Computer systems organization~Redundancy}
% \ccsdesc{Computer systems organization~Robotics}
% \ccsdesc[100]{Networks~Network reliability}

% %% Keywords. The author(s) should pick words that accurately describe
% %% the work being presented. Separate the keywords with commas.
% \keywords{datasets, neural networks, gaze detection, text tagging}

%% This command processes the author and affiliation and title
%% information and builds the first part of the formatted document.
\maketitle

\section{Introduction}

\reed{How do authors/affiliations work for this?}
\langName is a DSL for implementing programs which manage \assetTxt{}s, targeted at writing smart contracts.

\subsection{Contributions}

We make the following contributions with \langName.
\begin{itemize}
    \item \textbf{Flow abstraction}: \langName uses a new abstraction called a \emph{flow} to encode semantic information about a program into the code.
        \reed{Is this a contribution or does it just enable the other contributions?}

    \item \textbf{Safety guarantees}: \langName ensures that \assetTxt{}s are properly managed, eliminating double-spend and \assetTxt-loss bugs.

    \item \textbf{Conciseness}: \langName makes writing typical smart contract programs more concise by handling common pitfalls automatically.

    % \item \reed{Optimizations? Probably don't have time for this, unfortunately.}
    %     Some of the Solidity contracts are actually inefficient because:
    %     \begin{enumerate}
    %         \item They use lots of modifiers which repeat checks (see reference implementation of ERC-721).
    %         \item They tend to use arrays to represent sets.
    %             Maybe this is more efficient for very small sets, but checking containment is going to be much faster with a \lstinline{mapping (X => bool)} eventually.
    %     \end{enumerate}

    %     \begin{itemize}
    %         \item We can evaluate this by profiling or a simple opcode count (which is not only a proxy for performance, but also means that deploying the contract will be cheaper).
    %     \end{itemize}
\end{itemize}

handled by the language; these include handling overflow/underflow, checking of balances, short address attacks \reed{Do this}, string operations, etc.
This conciseness is not only an improvement for a developers workflow, but also means that such issues are automatically handled, making it impossible for developers to forget them \reed{Wording}.
\begin{itemize}
    \item We can evaluate these by comparing LOC, cyclomatic complexity, etc.
        Not sure what the right metric would be.
        \reed{Or how cyclomatic complexity would work exactly in this language.}

    \item We can also evaluate via a user study, but that will take a long(er) time.
\end{itemize}

\section{Language Description}

\subsection{Syntax}
\begin{figure}[t]
\begin{tabular}{l r l l}
    $\mathfrak{q}$ & \bnfdef & $\exactlyone$ \bnfalt $\any$ \bnfalt $\nonempty$ & (selector quantifiers) \\
    $\mathcal{Q}$ & \bnfdef & $\mathfrak{q}$ \bnfalt $\emptyq$ \bnfalt $\every$ & (\typeQuantities) \\
    $T$ & \bnfdef & \boolt \bnfalt $\natt$ \bnfalt $\map~\tau~\Rightarrow~\sigma$ \bnfalt $t$ \bnfalt $\ldots$ & (base types) \\
    $\tau$ & \bnfdef & $\mathcal{Q}~T$ & (types) \\
    $\mathcal{V}$ & \bnfdef & $n$ \bnfalt \true \bnfalt \false \bnfalt $\emptyval$ \bnfalt $\ldots$ & (values) \\
    $\mathcal{L}$ & \bnfdef & $x$ \bnfalt $x[x]$ \bnfalt $x.x$ & (locations) \\
    $E$ & \bnfdef & $\mathcal{V}$ \bnfalt $\mathcal{L}$ \bnfalt $\total~t$ \bnfalt $\ldots$ & (expressions) \\
    $s$ & \bnfdef & $\mathcal{L}$ \bnfalt $\everything$ \bnfalt $\mathfrak{q}~x : \tau~\suchthat~E$ & (selector) \\
    $\mathcal{S}$ & \bnfdef & $\mathcal{L}$ \bnfalt $\newc~t$ & (sources) \\
    $\mathcal{D}$ & \bnfdef & $\mathcal{L}$ \bnfalt $\consume$ & (destinations) \\
    $F$ & \bnfdef & $\mathcal{S} \sends{s} x \to \mathcal{D}$ & (flows) \\
    $\Stmt$ & \bnfdef & $F$ \bnfalt $S;S$ \bnfalt $\ldots$ & (statements) \\
    $M$ & \bnfdef & \fungible \bnfalt \nonfungible & \\
        & \bnfalt & \consumable \bnfalt \asset & (type modifiers) \\
    $\Decl$ & \bnfdef & $\type~t~\is~\overline{M}~T$ & (type declaration) \\
            & \bnfalt & $\transaction~m(\overline{x : \tau})~\returns~x : \tau~\doC~S$ & (transactions) \\
            & \bnfalt & $\ldots$ & \\
    $\Con$ & \bnfdef & $\contract~C~\{~\overline{\Decl}~\}$ & (contracts) \\
\end{tabular}
\caption{A fragment of the abstract syntax of the core calculus of \langName.}
\label{fig:lang-syntax}
\end{figure}

Figure~\ref{fig:lang-syntax} shows a fragment of the syntax of the core calculus of \langName, which uses A-normal form \reed{cite} and makes several simplifications to the surface \langName language.
These simplifications are performed automatically by the compiler.
\reed{TODO: The core calculus has been formalized (in K???).}

\subsection{Flows}
The \langName language is built around the concept of a \emph{flow}, an atomic, state-changing operation describing the transfer of a \assetTxt.
Each flow has at least a \emph{source} and a \emph{destination}; they may optionally have a \emph{selector} or a transformer.
The source and destination are two storages which \emph{provide} and \emph{accept} \assetTxt{}s, and the selector, if present, describes which part of the \assetTxt in the source should be transferred to the destination.
If not present, all \assetTxt{}s will be transferred.

All flows fail if the selected \assetTxt{}s are not present in the source, or if the selected \assetTxt{}s cannot be added to the destination.
For example, a flow of fungible \assetTxt{}s fails if there is not enough of the \assetTxt, and a flow of a nonfungible \assetTxt fails if the selected value doesn't exist in the source location.

There are two special kinds of \assetTxt{}s: \emph{fungible} and \emph{nonfungible}.
\reed{I think there's also \assetTxt{}s which are neither fungible nor nonfungible.}
\reed{Not really sure about these definitions}
Fungible \assetTxt{}s are those whose values are not unique and can be combined: for example, ERC-20 tokens are fungible, because two accounts may have the same number of tokens---the number isn't the token, but instead describes \textbf{how many} tokens there are.
\reed{Fungible is two things? Isn't that kind of confusing?}
A nonfungible \assetTxt is an \assetTxt that is unique, and can be held in at most one location.
Notably, nonfungible \assetTxt{}s \textbf{must} be unique.
For example, ERC-721 \reed{cite} tokens are nonfungible---each token is unique and can be held by at most one account at a time.
\langName will automatically and dynamically ensure that all newly created nonfungible \assetTxt{}s are unique.
Furthermore, it supports data structures that make working with \assetTxt{}s easier, such as \emph{linkings}, which provide a useful abstraction of an account of nonfungible \assetTxt{}s.
\reed{Is it worth discussing this?}
\reed{Why couldn't you jsut wrie this as alibrary}
\reed{Need to merge this stuff with the more in-depth discussion of examples later.}
\reed{How to balance discussion of the various benefits between here and the examples sections?}

\subsection{Benefits}
\reed{Potential benefits:
\begin{itemize}
    \item Good expression of financial \assetTxt{}s: fungilbe, nonfungible/general uniqueness constraints. Consumable vs. nonconsumable. NOTE: These are things that Obsidian can't express. Emphasize the uniqueness stuff is actually not any more difficult/inefficient than existing solutions.
    \item Atomic flow construct encodes semantic intent
    \item Maybe efficient, but would need an implementation to evaluate this.
    \item Flows are good and interesting.
\end{itemize}}

\section{Case Studies}
\subsection{ERC-20}
\reed{NOTE: I removed the MAX\_UINT thing that gives an unlimited approval from ERC20.sol, because that's not part of the standard and not particularly interesting.}
\reed{Cite properly Solidity code properly}

Figure~\ref{fig:erc20-impl} shows implementations of the ERC-20 \reed{cite} standard in both Solidity and \langName, one of the most commonly implemented standards on the Ethereum blockchain \reed{cite}.
Only the core functions of \lstinline{transfer}, \lstinline{transferFrom}, and \lstinline{approve} are shown, with the exception of \lstinline{totalSupply} in the \langName implementation (included because to show the use of the \total operator).
All event code has been omitted, because \langName handles events in the same way as Solidity.
This code shows several advantages of the flow abstraction:
\begin{itemize}
    \item Precondition checking: For a flow to succeed, the source must have enough \assetTxt{}s and the destination must be capable of receiving the \assetTxt{}s flowed.
        In this case, the balance of the sender must be greater than the amount sent, and the balance of the destination must not overflow when it receives the tokens.
        Code checking these two conditions is automatically inserted, ensuring that the checks cannot be forgotten.
    \item Error messages: When a flow fails, we provide \reed{TODO: **will provide**} automatic, descriptive error messages, such as ``\lstinline{Failed to flow '<amount>' Token from account[<src>] to account[<dst>]: account[<dst>] does not have enough Token.}''.
        \reed{Not sure exactly what the error message should be.}
        The default implementation provides no error message forcing developers to write their own.
        Flows enable the generation of the messages by encoding the semantic information of a \textbf{transfer} into the program, instead of using low-level incrementing and decrementing.
\end{itemize}

\begin{figure*}[h]
    \centering
    \begin{minipage}[t]{0.5\textwidth}
        \lstinputlisting{splash20-examples/erc20.sol}
    \end{minipage}%
    \begin{minipage}[t]{0.5\textwidth}
        \lstinputlisting{splash20-examples/erc20.flow}
    \end{minipage}
    \caption{A Solidity and a \langName implementation of the core functions of the ERC-20 standard.}
    \label{fig:erc20-impl}
\end{figure*}

\subsection{ERC-721}
\begin{figure*}[h]
    \centering
    \begin{minipage}[t]{0.5\textwidth}
        \lstinputlisting{splash20-examples/erc721.sol}
    \end{minipage}%
    \begin{minipage}[t]{0.5\textwidth}
        \lstinputlisting{splash20-examples/erc721.flow}
    \end{minipage}
    \caption{A Solidity and a \langName implementation of the core functions of the ERC-20 standard.}
    \label{fig:erc20-impl}
\end{figure*}

\reed{Another benefit here is that linkings are a good datastructure for accounts of nonfungible \assetTxt{}s.
Of course, you could always implement a linking in a Solidity library...
However, you still wouldn't have the property that only one account is guaranteed to hold each token, because of the nonfungibility/uniqueness.}

The ERC-721 standard \reed{cite} requires many invariants hold:
    they must be unique,
    at most one non-owning account can have ``approval'' for a token,
    we must be able to support ``operators'' who can manage all of the tokens of a user,
    among others.
Because \langName is designed to handle \assetTxt{}s, it makes, and removes the burden of ensuring these correctness properties hold from developers.
\reed{A \langName implementation has several benefits: because of the \assetTxt abstraction, we can be sure that tokens will not be}
\reed{I think we should focus on the benefits of nonfungible \assetTxt{}s + linkings here in easily and correctly expressing these invariants, and ignore all the other functions.}

\subsection{Voting}

\subsection{The DAO attack}
\reed{Describe attack}
We can prevent the DAO attack (the below is from \url{https://consensys.github.io/smart-contract-best-practices/known_attacks/}):
\begin{lstlisting}
function withdrawBalance() public {
    uint amountToWithdraw = userBalances[msg.sender];
    // At this point, the caller's code is executed, and
    // can call withdrawBalance again
    require(msg.sender.call.value(amountToWithdraw)(""));
    userBalances[msg.sender] = 0;
}
\end{lstlisting}

In \langName, we would write this as:

\begin{lstlisting}
transaction withdrawBalance():
    userBalances[msg.sender] --> msg.sender.balance
\end{lstlisting}

Because of the additional information encoded in the flow construct, the compiler can output the safe version of the above code---reducing the balance before peforming the call---without any user intervention.

\section{Discussion}

\section{Related Work}
\reed{?}

\section{Conclusion}

%% The next two lines define the bibliography style to be used, and
%% the bibliography file.
\bibliographystyle{ACM-Reference-Format}
\bibliography{biblio}

%%
%% If your work has an appendix, this is the place to put it.
\appendix

\section{Appendix}

\end{document}
\endinput

