\documentclass[nonacm, dvipsnames, sigconf]{acmart}

\usepackage{listings}
\usepackage{hyperref}
\usepackage{dblfloatfix}
\usepackage{tikz-cd}
% \usepackage{amssymb}
\usepackage{amsthm}
\usepackage{bm}
\usepackage{listings}
\usepackage{mathtools}
\usepackage{mathpartir}
\usepackage{float}
\usepackage{subcaption}
\usepackage{xcolor}
\usepackage[safe]{tipa}
\usepackage[inline]{enumitem}

%% \BibTeX command to typeset BibTeX logo in the docs
% \AtBeginDocument{%
%   \providecommand\BibTeX{{%
%     \normalfont B\kern-0.5em{\scshape i\kern-0.25em b}\kern-0.8em\TeX}}}

%% Rights management information.  This information is sent to you
%% when you complete the rights form.  These commands have SAMPLE
%% values in them; it is your responsibility as an author to replace
%% the commands and values with those provided to you when you
%% complete the rights form.
% \setcopyright{acmcopyright}
% \copyrightyear{2018}
% \acmYear{2018}
% \acmDOI{10.1145/1122445.1122456}

%% These commands are for a PROCEEDINGS abstract or paper.
% \acmConference[Woodstock '18]{Woodstock '18: ACM Symposium on Neural
%   Gaze Detection}{June 03--05, 2018}{Woodstock, NY}
% \acmBooktitle{Woodstock '18: ACM Symposium on Neural Gaze Detection,
%   June 03--05, 2018, Woodstock, NY}
% \acmPrice{15.00}
% \acmISBN{978-1-4503-XXXX-X/18/06}

%% Submission ID.
%% Use this when submitting an article to a sponsored event. You'll
%% receive a unique submission ID from the organizers
%% of the event, and this ID should be used as the parameter to this command.
%%\acmSubmissionID{123-A56-BU3}

\input{LaTeX/macros.tex}
\input{solidity-latex-highlighting/solidity-highlighting.tex}
\input{flow-highlighting.tex}
\input{macros.tex}

\addtolength{\textfloatsep}{-1.5em}

\settopmatter{printfolios=true}

\begin{document}

%% The "title" command has an optional parameter,
%% allowing the author to define a "short title" to be used in page headers.
\title{\langName: A DSL for Safe Blockchain \AssetTxt{}s}

%% The "author" command and its associated commands are used to define
%% the authors and their affiliations.
%% Of note is the shared affiliation of the first two authors, and the
%% "authornote" and "authornotemark" commands
%% used to denote shared contribution to the research.
\author{Reed Oei}
\affiliation{%
    \institution{University of Illinois}
  % \city{Urbana}
  % \country{USA}
}
\email{reedoei2@illinois.edu}

%% By default, the full list of authors will be used in the page
%% headers. Often, this list is too long, and will overlap
%% other information printed in the page headers. This command allows
%% the author to define a more concise list
%% of authors' names for this purpose.
% \renewcommand{\shortauthors}{Trovato and Tobin, et al.}

%% The abstract is a short summary of the work to be presented in the
%% article.
\begin{abstract}
% Blockchains host smart contracts for crowdfunding, tokens, and many other purposes.
% However, vulnerabilities in contracts are often discovered, leading to the loss of large quantities of money.
% Psamathe is a new language we are designing around a new flow abstraction, reducing asset bugs and making contracts more concise than in existing languages.
% We present an overview of Psamathe, and discuss two example contracts in Psamathe and Solidity.
\end{abstract}

%% The code below is generated by the tool at http://dl.acm.org/ccs.cfm.
%% Please copy and paste the code instead of the example below.
% \begin{CCSXML}
% <ccs2012>
%  <concept>
%   <concept_id>10010520.10010553.10010562</concept_id>
%   <concept_desc>Computer systems organization~Embedded systems</concept_desc>
%   <concept_significance>500</concept_significance>
%  </concept>
%  <concept>
%   <concept_id>10010520.10010575.10010755</concept_id>
%   <concept_desc>Computer systems organization~Redundancy</concept_desc>
%   <concept_significance>300</concept_significance>
%  </concept>
%  <concept>
%   <concept_id>10010520.10010553.10010554</concept_id>
%   <concept_desc>Computer systems organization~Robotics</concept_desc>
%   <concept_significance>100</concept_significance>
%  </concept>
%  <concept>
%   <concept_id>10003033.10003083.10003095</concept_id>
%   <concept_desc>Networks~Network reliability</concept_desc>
%   <concept_significance>100</concept_significance>
%  </concept>
% </ccs2012>
% \end{CCSXML}

% \ccsdesc[500]{Computer systems organization~Embedded systems}
% \ccsdesc[300]{Computer systems organization~Redundancy}
% \ccsdesc{Computer systems organization~Robotics}
% \ccsdesc[100]{Networks~Network reliability}

% %% Keywords. The author(s) should pick words that accurately describe
% %% the work being presented. Separate the keywords with commas.
% \keywords{datasets, neural networks, gaze detection, text tagging}

%% This command processes the author and affiliation and title
%% information and builds the first part of the formatted document.
\maketitle

\section{Introduction}
\reed{Seems like we should emphasize two things: why is this language declarative, and why are our programs easier to verify than Solidity programs (are they)?}
\reed{The other thing they seem to really care about is performance.}

\reed{Should we put any effort into actually verifying things?}

\reed{This paragraph is completely unchanged atm, but could use updating.}
Blockchains are increasingly used as platforms for applications called \emph{smart contracts}~\cite{Szabo97:Formalizing}, which automatically manage transactions in an unbiased, mutually agreed-upon way.
Commonly proposed and implemented smart contracts include supply chain management~\cite{SupplyChainUse}, healthcare~\cite{HealthcareUse}, \emph{token contracts}, voting, crowdfunding, auctions, and more~\cite{Elsden18:Making}.
A \emph{token contract} is a contract implementing a \emph{token standard}, such as ERC-20~\cite{erc20}.
Smart contracts often manage \emph{digital assets}, such as cryptocurrencies, or, depending on the application, bids in an auction, votes in an election, and so on.
Token contracts are common on the Ethereum blockchain~\cite{wood2014ethereum}---about 73\% of high-activity contracts are token contracts~\cite{OlivaEtAl2019}.
Smart contracts cannot be patched after being deployed, even if a security vulnerability is discovered.
Some estimates suggest that as much as 46\% of smart contracts may have some vulnerability~\cite{luuOyente}.
\begin{figure}
    \centering
    \lstinputlisting[language=Solidity]{padl-21-examples/erc20-transfer.sol}
    \vspace{-1em}
    \caption{An implementation of ERC-20's \lstinline{transfer} function in Solidity from one of the reference implementations~\cite{erc20Consensys}.
        All preconditions are checked manually.
        Note that we must include the \lstinline{SafeMath} library (not shown), which checks for underflow/overflow, to use the \lstinline{add} and \lstinline{sub} functions.}
    \label{fig:erc20-transfer-sol}
\end{figure}

\langName (\langNamePronounce) is a new programming language we are designing around a new abstraction, a \emph{flow}, representing an atomic transfer operation.
\Fix{Together with \emph{modifiers} and \emph{locators}, flows provide a \textbf{concise} way to write smart contracts that \textbf{safely} manage \assetTxt{}s.}

Solidity is the most commonly-used smart contract language on the Ethereum blockchain~\cite{EthereumForDevs}, and does not provide analogous support for managing \assetTxt{}s.
Typical smart contracts are more concise in \langName than in Solidity, because \langName handles common patterns and pitfalls automatically.

Other many newly-proposed blockchain languages include Flint, Move, Nomos, Obsidian, and Scilla~\cite{schrans2018flint, blackshear2019move, das2019nomos, coblenz2019obsidian, sergey2019scilla}.
Scilla and Move are intermediate-level languages, whereas \langName is a high-level language.
Obsidian, Move, Nomos, and Flint use linear or affine types to manage \assetTxt{}s; \langName uses \emph{type quantities}, which provide the benefits of \emph{linear types}, but give a more precise analysis of the flow of values in a program.
\Fix{None of the these languages have flows, provide support for all the modifiers that \langName does, or have locators.
In particular, the latter means that programs in those languages using linear or affine types must be more verbose to maintain linearity.}

\section{Language}\label{sec:lang}
\Fix{A \langName program is made of \emph{transformers} and \emph{types}.
Transformers contain statements describing the flow of values between the variables of the transformer.
Types provide a mechanism for marking values with \emph{modifiers}.}
Figure~\ref{fig:erc20-transfer-flow} shows a simple contract declaring a type and a transformer, which implements the core of ERC-20's \lstinline{transfer} function.
ERC-20 is a standard for token contracts managing \textbf{fungible} tokens, and provides a bare-bones interface for this purpose.
\begin{figure}
    \centering
    \lstinputlisting[language=flow, xrightmargin=-1.0em]{padl-21-examples/erc20-transfer.flow}
    \vspace{-1em}
    \caption{A \langName contract with a simple \lstinline{transfer} function, which transfers \lstinline{amount} tokens from the sender's account to the destination account.
It is implemented with a single flow, which automatically checks all the preconditions to ensure the transfer is valid.}
    \label{fig:erc20-transfer-flow}
\end{figure}

\langName is built around the concept of a flow.
Using the more declarative, \emph{flow-based} approach provides the following advantages:
\begin{itemize}
    \item \Fix{\textbf{Asset retention}: Because of the design of the language, each flow is guaranteed to preserve the total amount of assets (except for flows that consume or allocate assets), removing the need to verify such properties.}
    \item \textbf{Precondition checking}: \langName automatically inserts dynamic checks of a flow's validity; e.g., a flow of money would fail if there is not enough money in the source, or if there is too much in the destination (e.g., due to overflow).
    \item \textbf{Data-flow tracking}: We hypothesize that flows provide a clearer way of specifying how resources flow in the code itself, which may be less apparent using other approaches, especially in complicated contracts.
        Additionally, developers must explicitly mark when \assetTxt{}s are \emph{consumed}, and only assets marked as \flowinline{consumable} may be consumed.
    \item \textbf{Error messages}: When a flow fails, \langName provides automatic, descriptive error messages, such as
\begin{lstlisting}[numbers=none, basicstyle=\small\ttfamily, xleftmargin=-5.0ex]
Cannot flow <amount> Token from account[<src>] to account[<dst>]:
    source only has <balance> Token.
\end{lstlisting}
        Flows enable such messages by encoding all the necessary information into the program.
\end{itemize}

Each variable and function parameter has a \emph{type quantity}, approximating the number of values in the variable, which is one of: $\emptyq$, $\any$, $\exactlyone$, $\nonempty$, $\every$ (``$\exactlyone$'' means ``exactly one'').
Type quantities are inferred if omitted.
Only $\emptyq$ asset variables may be dropped.

\emph{Modifiers} can be used to place constraints on how values are managed: \flowinline{asset}, \flowinline{fungible}, \flowinline{unique}, \flowinline{immutable}, and \flowinline{consumable}.
An \flowinline{asset} is a value that must not be reused or accidentally lost.
A \flowinline{fungible} value represents a quantity that can be \textbf{merged}, and it is \textbf{not} \flowinline{unique}.
For example, ERC-20 tokens are \flowinline{fungible}.
A \flowinline{immutable} value cannot be changed; in particular, it cannot be the source or destination of a flow.
A \flowinline{unique} value only exists in at most one variable; it must be \flowinline{immutable} and an \flowinline{asset} to ensure it is not duplicated.
ERC-721 tokens are \flowinline{unique} and \flowinline{immutable}.
A \flowinline{consumable} value is an \flowinline{asset} that it may be appropriate to dispose of, done via the \flowinline{consume} construct, documenting that the disposal is intentional.

\reed{TODO: Discuss locators}
\Fix{\emph{Locators} are expressions that allow accessing or modifying parts of complex structures while maintaining linearity.
}

\langName has transactional semantics: a sequence of flows will either all succeed, or, if a single flow fails, the rest will fail as well.
If a sequence of flows fails, the error propagates, like an exception, until it either: a) reaches the top level, and the entire transaction fails; or b) reaches a \flowinline{catch}, and then only the changes made in the corresponding \flowinline{try} block will be reverted, and the code in the \flowinline{catch} block will be executed.

\section{Examples}
\begin{figure}
    \centering
    \lstinputlisting[language=Solidity]{padl-21-examples/voting.sol}
    \vspace{-1em}
    \caption{A simple voting contract in Solidity.}
    \label{fig:voting-impl-sol}
\end{figure}
The complete Solidity and \langName code is in our repository~\cite{psamatheRepo}.

\subsection{ERC-20}\label{sec:erc20-impl}
Figure~\ref{fig:erc20-transfer-sol} shows a Solidity implementation of the ERC-20 function \lstinline{transfer} (cf. Figure~\ref{fig:erc20-transfer-flow}).
Each ERC-20 contract manages the ``bank accounts'' for its own tokens, keeping track of how many tokens each user has; users are represented by addresses.
This example shows the advantages of flows in precondition checking, data-flow tracking, and error messages.
In this case, the sender's balance must be at least as large as \flowinline{amount}, and the destination's balance must not overflow when it receives the tokens.
Psamathe automatically inserts code checking these two conditions, ensuring that the checks are not forgotten.

\reed{Why declarative}
\reed{Why easy to verify}
\reed{Why just as fast}

\subsection{Voting}\label{sec:voting-impl}
\begin{figure}
    \centering
    \lstinputlisting[language=flow]{padl-21-examples/voting.flow}
    \vspace{-1em}
    \caption{A simple voting contract in \langName.}
    \label{fig:voting-impl-flow}
\end{figure}
One proposed use for blockchains is for voting~\cite{Elsden18:Making}.
Figures~\ref{fig:voting-impl-sol} and~\ref{fig:voting-impl-flow} show the core of an implementation of a voting contract in Solidity and \langName, respectively, based on the Solidity by Example tutorial~\cite{solidityByExample}.
Each contract instance has several proposals, and users must be given permission to vote by the chairperson, assigned in the constructor of the contract (not shown).
Each user can vote exactly once for exactly one proposal, and the proposal with the most votes wins.

This example shows \langName is suited for a range of applications.
It also shows some uses of the $\unique$ modifier; in this contract, $\unique$ ensures that each user, represented by an \lstinline{address}, can be given permission to vote at most once, while the use of $\asset$ ensures that votes are not lost or double-counted.

\reed{Why declarative}
\reed{Why easy to verify}
\reed{Why just as fast}

\subsection{Blind Auction}\label{sec:blind-auction-impl}
\begin{figure}
    \centering
    \lstinputlisting[language=flow]{padl-21-examples/blind-auction.flow}
    \vspace{-1em}
    \caption{\reed{TODO}}
    \label{fig:blind-auction-impl-flow}
\end{figure}
\Fix{TODO: Describe}

\section{Conclusion and Future Work}

We have presented the \langName langauge for writing safer smart contracts.
\langName uses the new flow abstraction, \assetTxt{}s, and modifiers to provide safety guarantees for smart contracts.
We shown two examples of smart contracts in both Solidity and \langName, showing that \langName is capable of expressing common smart contract functionality in a concise manner, while retaining key safety properties.

In the future, we plan to implement the \langName language, and prove its safety properties.
We also hope to study the benefits of the language via case studies, performance evaluation, and the application of flows to other domains.
Finally, we would also like to conduct a user study to evaluate the usability of the flow abstraction and the design of the language, and to compare it to Solidity, which we hypothesize will show that developers write contracts with fewer asset management errors in \langName than in Solidity.

%% The next two lines define the bibliography style to be used, and
%% the bibliography file.
\bibliographystyle{ACM-Reference-Format}
\bibliography{biblio}

\end{document}
\endinput

