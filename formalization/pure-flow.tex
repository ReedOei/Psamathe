\documentclass[10pt]{article}

\usepackage{amsmath}
\usepackage{hyperref}
\usepackage{tikz-cd}
\usepackage{amssymb}
\usepackage{amsthm}
\usepackage{bm}
\usepackage{listings}
\usepackage{bbm}
\usepackage{multicol}
\usepackage{mathtools}
\usepackage{mathpartir}
\usepackage{float}
\usepackage[inline]{enumitem}
\usepackage[margin=1.25in]{geometry}
\usepackage[T1]{fontenc}
\usepackage{kpfonts}

\usetikzlibrary{decorations.pathmorphing}

\input{LaTeX/macros.tex}
\input{macros.tex}

\newcommand{\putS}{\textbf{\texttt{put}}\xspace}
\newcommand{\evaluates}{\Downarrow}

\begin{document}

\section{Specification}

\subsection{Syntax}
\begin{tabular}{l r l l}
    $\mathcal{Q}$, $\mathcal{R}$, $\mathcal{S}$ & \bnfdef & $\exactlyone$ \bnfalt $\any$ \bnfalt $\nonempty$ \bnfalt $\emptyq$ \bnfalt $\every$ \\
    $M$ & \bnfdef & \fungible \bnfalt \unique \bnfalt \immutable \bnfalt \consumable \bnfalt \asset & (type declaration modifiers) \\
    $T$ & \bnfdef & $\alpha \bnfalt \type~t~\is~\overline{M}~T \bnfalt \listq~\tau \bnfalt \tau \to \tau \bnfalt \forall \alpha . \tau$ \\
    $\tau$, $\sigma$, $\pi$ & \bnfdef & $\mathcal{Q}~T$ \\
    $S$ & \bnfdef & $E$ \bnfalt $\mathcal{Q}~x : \tau~\suchthat~E$ \\
    $E$ & \bnfdef & $\emptyset \bnfalt \curlys{E} \bnfalt x \bnfalt \lambda x : \tau . E \bnfalt \Lambda \alpha . E \bnfalt E ~ E \bnfalt E[T] \bnfalt E \sends{E} E$ \\
\end{tabular}

\subsection{Statics}

\framebox{$\Gamma \flowproves S~\ok \flowprovesout \Delta$} \textbf{Statement Well-formedness}
\begin{mathpar}
    \inferrule*[right=Flow-Every]{
        \Gamma \flowproves A : \mathcal{Q}~T \flowprovesout \Delta
        \\
        \Delta[A \leftarrow \Delta(A) \ominus \mathcal{Q}] \flowproves B : \mathcal{Q}~T \flowprovesout \Xi
    }{ \Gamma \flowproves (A \to B)~\ok \flowprovesout \Xi[B \leftarrow \Xi(B) \oplus \mathcal{Q}] }

    \inferrule*[right=Flow-Filter]{
        \elemtype(\tau) = \sigma
        \\
        \Gamma \flowproves A : \tau \flowprovesout \Delta
        \\
        \Delta[A \leftarrow \Delta(A) \ominus \mathcal{Q}] \flowproves B : \mathcal{S}~T \flowprovesout \Xi
        \\
        \transformer~f(\overline{x : \sigma}) \to y : \pi ~\doC~ \overline{\Stmt}
    }{ \Gamma \flowproves (A \sends{\mathcal{R}~\suchthat~f(\overline{a})} B)~\ok \flowprovesout \Xi[B \leftarrow \Xi(B) \oplus \min(\mathcal{Q}, \mathcal{R})] }

    \inferrule*[right=Flow-Transformer]{
        \forall v \in \overline{x}. \lnot(\Gamma(v)~\asset)
        \\
        \Gamma \flowproves A : \mathcal{Q}~T \flowprovesout \Delta
        \\
        \Delta[A \leftarrow \Delta(A) \ominus \mathcal{Q}] \flowproves B : \mathcal{Q}~T \flowprovesout \Xi
        \\
        \transformer~f(\overline{x : \sigma}) \to y : \pi ~\doC~ \overline{\Stmt}
    }{ \Gamma \flowproves (A \to f(\overline{x}) \to B)~\ok \flowprovesout \Xi[B \leftarrow \Xi(B) \oplus \mathcal{Q}] }
\end{mathpar}

\subsection{Dynamics}
\begin{tabular}{l r l l}
    $\mathcal{V}$ & \bnfdef & $\overline{V}$
\end{tabular}

\begin{mathpar}
    \inferrule*[right=Pass]{
    }{ \Sigma, \pass \to \Sigma }

    \inferrule*[right=Put-Consume]{
    }{ \Sigma, \putS(\mathcal{V}, \consume) \to \Sigma }

    \inferrule*[right=Flow-Every]{
        \Sigma(A) = \mathcal{V}
        \\
        \Sigma(B) = \mathcal{W}
    }{ \angles{\Sigma, A \to B} \evaluates \Sigma[A \leftarrow [], B \leftarrow \mathcal{W}\mathcal{V}] }

    \inferrule*[right=Flow-Filter]{
        \Sigma(A) = \mathcal{V}
        \\
        \Sigma(B) = \mathcal{W}
        \\
        \mathcal{U} = [ v \in \mathcal{V} ~|~ \parens{\Sigma, f(\overline{x}, v) \to^* \Sigma', \ell} \tand \Sigma'(\ell) = \true ]
    }{ \Sigma, (A \sends{\mathcal{Q}~\suchthat~f(\overline{x})} B) \to \Sigma[A \leftarrow \mathcal{V} \setminus \mathcal{U}, B \leftarrow \mathcal{W} \mathcal{U}] }

    \inferrule*[right=Call]{
        \ell \not\in \dom(\Sigma)
        \\
        \transformer~f(\overline{y : \tau}) \to z : \sigma~\doC~S
        \\
        \Sigma[y \leftarrow \ell, \overline{y \leftarrow \Sigma(x)}], f(\overline{x}) \to^* \Sigma'
    }{ \Sigma, f(\overline{x}) \to \Sigma'[\ell \leftarrow \Sigma'(z)], \ell }
\end{mathpar}

\end{document}

